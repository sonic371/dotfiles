#!/usr/bin/env sh

cachedir="${XDG_CACHE_HOME:-"$HOME/.cache"}"
cache_file="$cachedir/dmenu_desktop_cache"

[[ ! -e "$cachedir" ]] && mkdir -p "$cachedir"

# If no arguments are passed, it means we should list the applications
if [[ $# -eq 0 ]]; then
    # Rebuild cache using pure bash
    > "$cache_file" # Clear the cache file

    # Process all desktop files
    while IFS= read -r -d '' desktop_file; do
        local_name=""
        local_exec=""

        # Read file line by line
        while IFS= read -r line; do
            # Check for Name= line
            if [[ -z "$local_name" && "$line" == Name=* ]]; then
                local_name="${line#Name=}"
            fi

            # Check for Exec= line
            if [[ -z "$local_exec" && "$line" == Exec=* ]]; then
                local_exec="${line#Exec=}"
                # Remove % arguments (space + % + any character)
                local_exec="${local_exec// %?/ }"
            fi

            # If we have both, we're done with this file
            if [[ -n "$local_name" && -n "$local_exec" ]]; then
                echo "${local_name}|${local_exec}" >> "$cache_file"
                break
            fi
        done < "$desktop_file"
    done < <(find -L /usr/share/applications ~/.local/share/applications -name "*.desktop" -print0 2>/dev/null)

    # Output unique names for dmenu display
    if [[ -s "$cache_file" ]]; then
        while IFS='|' read -r name _; do
            echo "$name"
        done < "$cache_file" | sort -u
    fi
else
    # An argument was passed, it's the selected name, so lookup and output the Exec command
    selected_name="$1"
    if [[ -n "$selected_name" && -s "$cache_file" ]]; then
        while IFS='|' read -r name exec_cmd; do
            if [[ "$name" == "$selected_name" ]]; then
                echo "$exec_cmd"
                break
            fi
        done < "$cache_file"
    fi
fi
