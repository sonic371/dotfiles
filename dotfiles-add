#!/bin/bash
# Interactive dotfiles manager
# Usage: dotfiles-add [config-name]

set -e  # Exit on error

DOTFILES_DIR="${DOTFILES_DIR:-$HOME/dotfiles}"
CONFIG_NAME=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}========================================${NC}"
    echo -e "${BLUE}  Dotfiles Manager${NC}"
    echo -e "${BLUE}========================================${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

check_dotfiles_dir() {
    if [ ! -d "$DOTFILES_DIR" ]; then
        print_error "Dotfiles directory not found: $DOTFILES_DIR"
        echo "Create it with: mkdir -p ~/dotfiles && cd ~/dotfiles && git init"
        exit 1
    fi
}

get_config_name() {
    if [ -n "$1" ]; then
        CONFIG_NAME="$1"
    else
        echo -n "Enter config name (e.g., polybar, i3, alacritty): "
        read -r CONFIG_NAME
        
        if [ -z "$CONFIG_NAME" ]; then
            print_error "No config name provided"
            exit 1
        fi
    fi
}

detect_config_path() {
    local config_name="$1"
    local possible_paths=(
        "$HOME/.config/$config_name"
        "$HOME/.$config_name"
        "$HOME/.${config_name}rc"
        "$HOME/.${config_name}_config"
        "$HOME/$config_name"
    )

    for path in "${possible_paths[@]}"; do
        if [ -e "$path" ]; then
            echo "$path"
            return 0
        fi
    done

    # Return empty string instead of failing
    echo ""
}

detect_stow_structure() {
    local config_name="$1"
    local config_path="$2"
    
    # If it's in .config/
    if [[ "$config_path" == "$HOME/.config/"* ]]; then
        local inner_path="${config_path#$HOME/.config/}"
        echo ".config/$inner_path"
    # If it's a dotfile in home
    elif [[ "$config_path" == "$HOME/."* ]]; then
        local inner_path="${config_path#$HOME/}"
        echo "$inner_path"
    # If it's a directory in home
    elif [[ "$config_path" == "$HOME/"* ]] && [ -d "$config_path" ]; then
        local inner_path="${config_path#$HOME/}"
        echo "$inner_path"
    else
        echo "$config_name"
    fi
}

backup_existing() {
    local target_path="$1"
    local backup_path="${target_path}.backup.$(date +%Y%m%d_%H%M%S)"

    # Use atomic mv if possible, otherwise copy then remove
    if [ -e "$target_path" ]; then
        print_warning "Backing up existing: $target_path → $backup_path"
        if ! mv "$target_path" "$backup_path" 2>/dev/null; then
            # If mv fails (e.g., across filesystems), copy then remove
            if [ -d "$target_path" ]; then
                cp -r "$target_path" "$backup_path" && rm -rf "$target_path"
            else
                cp "$target_path" "$backup_path" && rm -f "$target_path"
            fi
        fi
        echo "Original saved to: $backup_path"
    fi
}

add_config() {
    local config_name="$1"
    local config_path="$2"
    local stow_structure="$3"
    
    print_header
    
    # Create directory structure in dotfiles
    local dotfiles_path="$DOTFILES_DIR/$config_name/$stow_structure"
    print_success "Creating: $dotfiles_path"
    mkdir -p "$(dirname "$dotfiles_path")"
    
    # Copy files - always copy to the exact dotfiles_path
    if [ -d "$config_path" ]; then
        print_success "Copying directory: $config_path"
        # For directories, copy contents to dotfiles_path
        mkdir -p "$dotfiles_path"
        cp -r "$config_path"/. "$dotfiles_path"/
    elif [ -f "$config_path" ]; then
        print_success "Copying file: $config_path"
        cp "$config_path" "$dotfiles_path"
    else
        print_error "Not a file or directory: $config_path"
        return 1
    fi
    
    # Backup existing at target
    backup_existing "$config_path"
    
    # Stow it
    cd "$DOTFILES_DIR"
    print_success "Creating symlinks with stow..."
    if stow -v -t ~ "$config_name"; then
        print_success "Stow completed successfully!"
    else
        print_error "Stow failed. Use --adopt if you want to keep existing files."
        echo "Try: stow -t ~ --adopt $config_name"
        return 1
    fi
    
    # Git operations
    if [ -d "$DOTFILES_DIR/.git" ]; then
        print_success "Adding to git..."
        git add "$config_name/"
        
        echo -n "Enter git commit message (or press Enter for default): "
        read -r commit_msg
        if [ -z "$commit_msg" ]; then
            commit_msg="feat: add $config_name configuration"
        fi
        
        git commit -m "$commit_msg"
        print_success "Committed with message: $commit_msg"
    else
        print_warning "No git repository found in $DOTFILES_DIR"
    fi
    
    print_success "Configuration '$config_name' added to dotfiles!"
    echo ""
    echo "Files are now at: $DOTFILES_DIR/$config_name/"
    echo "Symlinks are at: $config_path"
}

main() {
    get_config_name "$1"
    check_dotfiles_dir
    
    print_success "Looking for: $CONFIG_NAME"
    
    # Detect where the config is
    config_path=$(detect_config_path "$CONFIG_NAME")
    
    if [ -z "$config_path" ]; then
        print_error "Could not find configuration for '$CONFIG_NAME'"
        echo "Common locations checked:"
        echo "  - ~/.config/$CONFIG_NAME/"
        echo "  - ~/.$CONFIG_NAME"
        echo "  - ~/.${CONFIG_NAME}rc"
        echo ""

        # Get and validate user input
        while true; do
            echo "Please specify full path:"
            read -r full_path

            # Basic validation: check if path exists and is within user's home
            if [ -z "$full_path" ]; then
                print_error "No path provided. Try again or press Ctrl+C to cancel."
                continue
            fi

            # Expand ~ and variables
            full_path=$(eval echo "$full_path")

            # Check if path exists
            if [ ! -e "$full_path" ]; then
                print_error "Path does not exist: $full_path"
                continue
            fi

            # Check if path is within user's home directory (security)
            if [[ "$full_path" != "$HOME"/* ]] && [[ "$full_path" != "$HOME" ]]; then
                print_warning "Warning: Path is outside your home directory: $full_path"
                read -p "Continue anyway? (y/N): " -n 1 -r
                echo ""
                if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                    continue
                fi
            fi

            config_path="$full_path"
            break
        done
    else
        print_success "Found at: $config_path"
    fi
    
    # Ask for confirmation
    echo ""
    echo "You are about to:"
    echo "1. Copy $config_path to $DOTFILES_DIR/$CONFIG_NAME/"
    echo "2. Backup original to $config_path.backup.[timestamp]"
    echo "3. Create symlinks with stow"
    echo "4. Commit to git (if git repo exists)"
    echo ""
    read -p "Continue? (y/N): " -n 1 -r
    echo ""
    
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_warning "Cancelled"
        exit 0
    fi
    
    # Detect stow structure
    stow_structure=$(detect_stow_structure "$CONFIG_NAME" "$config_path")
    
    # Add the config
    add_config "$CONFIG_NAME" "$config_path" "$stow_structure"
}

# Run main function
main "$@"
